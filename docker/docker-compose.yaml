version: '3.7'
services:
  swagger-stats:
    image: docker.okidoo.co/node-dev-16:latest
    container_name: swagger-stats
    dns: 1.1.1.1
    env_file:
      - ./.api.env
    command: tail -F anything
    networks:
      - swagger-stats
    ports:
      - ${API_DEV_PORT}:3000
    volumes:
      - ./.npmrc:/home/node/.npmrc
      - ../:/home/node/app
      - ~/.ssh/:/home/node/.ssh/
    depends_on:
      swagger-stats-mongo:
        condition: service_healthy

  swagger-stats-mongo:
    image: mongo:latest
    container_name: swagger-stats-mongo
    ports:
      - ${MONGO_DEV_PORT}:27017
    env_file:
      - ./.mongo.env
    volumes:
      - ./mongo:/data/db
    networks:
      - swagger-stats
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017 --quiet
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s

  swagger-stats-elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.14.2
    container_name: swagger-stats-elasticsearch
    dns: 1.1.1.1
    volumes:
      - ./elasticsearch:/usr/share/elasticsearch/data
    networks:
      - swagger-stats
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    cap_add:
      - IPC_LOCK
    environment:
      - xpack.security.enabled=false
      - discovery.type=single-node

  swagger-stats-redis:
    image: redis:latest
    container_name: swagger-stats-redis
    networks:
      - swagger-stats
    ports:
      - 6379:6379

networks:
  swagger-stats: